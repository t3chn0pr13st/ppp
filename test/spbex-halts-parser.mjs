import { fetch } from '../salt/states/ppp/lib/fetch.mjs';

const rss = `<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
  <channel>
    <title><![CDATA[Новости/Сообщения о технических сбоях и приостановке торгов]]></title>
    <link>https://spbexchange.ru/ru/about/news.aspx?rss=Y</link>
    <description><![CDATA[Новости/Сообщения о технических сбоях и приостановке торгов]]></description>
    <language>ru-RU</language>
    <lastBuildDate>Tue, 28 Dec 2021 06:57:42 UT</lastBuildDate>
    <generator><![CDATA[bitrix::iblock.rss]]></generator>
    <docs>http://cyber.law.harvard.edu/rss/rss.html</docs>
    <ttl>60</ttl>
    <item>
      <title><![CDATA[Сообщение о возобновлении организованных торгов ценными бумагами BridgeBio Pharma, Inc., US10806X1028]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27199</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27199</guid>
      <pubDate>Mon, 27 Dec 2021 12:41:02 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о приостановке организованных торгов ценными бумагами BridgeBio Pharma, Inc., US10806X1028]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27198</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27198</guid>
      <pubDate>Mon, 27 Dec 2021 12:41:00 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о возобновлении организованных торгов ценными бумагами Citibank, N.A., US78440P3064]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27194</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27194</guid>
      <pubDate>Mon, 27 Dec 2021 09:55:02 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о приостановке организованных торгов ценными бумагами Citibank, N.A., US78440P3064]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27193</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27193</guid>
      <pubDate>Mon, 27 Dec 2021 09:55:01 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о возобновлении организованных торгов ценными бумагами Allakos Inc., US01671P1003]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27157</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27157</guid>
      <pubDate>Wed, 22 Dec 2021 12:41:03 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о приостановке организованных торгов ценными бумагами Allakos Inc., US01671P1003]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27156</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27156</guid>
      <pubDate>Wed, 22 Dec 2021 12:41:02 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о возобновлении организованных торгов ценными бумагами Cassava Sciences, Inc., US14817C1071]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27138</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27138</guid>
      <pubDate>Tue, 21 Dec 2021 12:47:01 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о приостановке организованных торгов ценными бумагами Cassava Sciences, Inc., US14817C1071]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27137</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27137</guid>
      <pubDate>Tue, 21 Dec 2021 12:47:00 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о возобновлении организованных торгов ценными бумагами bluebird bio Inc., US09609G1004]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27131</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27131</guid>
      <pubDate>Tue, 21 Dec 2021 07:20:04 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о приостановке организованных торгов ценными бумагами bluebird bio Inc., US09609G1004]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27130</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27130</guid>
      <pubDate>Tue, 21 Dec 2021 07:20:03 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о возобновлении организованных торгов ценными бумагами Cerner Corporation, US1567821046]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27102</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27102</guid>
      <pubDate>Fri, 17 Dec 2021 07:29:03 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о приостановке организованных торгов ценными бумагами Cerner Corporation, US1567821046]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27101</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27101</guid>
      <pubDate>Fri, 17 Dec 2021 07:29:02 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о возобновлении организованных торгов ценными бумагами DermTech, Inc., US24984K1051]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27088</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27088</guid>
      <pubDate>Thu, 16 Dec 2021 08:46:05 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о приостановке организованных торгов ценными бумагами DermTech, Inc., US24984K1051]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27087</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27087</guid>
      <pubDate>Thu, 16 Dec 2021 08:46:02 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о возобновлении организованных торгов ценными бумагами CMC Materials, Inc., US12571T1007]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27080</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27080</guid>
      <pubDate>Wed, 15 Dec 2021 12:41:02 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о приостановке организованных торгов ценными бумагами CMC Materials, Inc., US12571T1007]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27079</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27079</guid>
      <pubDate>Wed, 15 Dec 2021 12:41:01 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о возобновлении организованных торгов ценными бумагами Terminix Global Holdings, Inc., US88087E1001]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27054</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27054</guid>
      <pubDate>Tue, 14 Dec 2021 09:44:03 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о приостановке организованных торгов ценными бумагами Terminix Global Holdings, Inc., US88087E1001]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27053</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27053</guid>
      <pubDate>Tue, 14 Dec 2021 09:44:01 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о возобновлении организованных торгов ценными бумагами Arena Pharmaceuticals, Inc., US0400476075]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27045</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27045</guid>
      <pubDate>Mon, 13 Dec 2021 11:42:02 UT</pubDate>
    </item>
    <item>
      <title><![CDATA[Сообщение о приостановке организованных торгов ценными бумагами Arena Pharmaceuticals, Inc., US0400476075]]></title>
      <link>https://spbexchange.ru/ru/about/news.aspx?section=17&amp;news=27044</link>
      <description />
      <category><![CDATA[Новости Иностранных акций]]></category>
      <category><![CDATA[Сообщения о технических сбоях и приостановке торгов]]></category>
      <guid isPermaLink="false">urn:bitrix:iblockelement:27044</guid>
      <pubDate>Mon, 13 Dec 2021 11:42:01 UT</pubDate>
    </item>
  </channel>
</rss>`;

function parse_spbex_halts() {
  return rss
    .match(
      /приостановке организованных торгов ценными бумагами [\s\S]+?<link>(.*?)<\/link>/gi
    )
    .map((l) => {
      const [title, link] = l
        .replace(/<link>/, '')
        .replace(/<\/link>/, '')
        .replace(/]]><\/title>/, '')
        .replace('&amp;', '&')
        .split(/\r?\n/);

      const p = title.split(/,/);
      const url = link.trim();
      const id = url.split(/news=/)[1];

      return {
        id,
        isin: p[p.length - 1].trim(),
        url
      };
    });
}

async function parse_spbex_halt(isin) {
  const { responseText: page } = await fetch(
    'https://spbexchange.ru/ru/about/news.aspx?section=17&news=27044'
  );

  const name = page.match(
    /приостановке организованных торгов ценными бумагами (.*?)<\/h1>/i
  )[1];
  const date = page.match(/<span class="news-date-time">(.*?)<\/span>/i)[1];
  const start = page.match(/приостановке в <b>([0-9:]+)<\/b>/)[1];
  const finish = page.match(/до <b>([0-9:]+)<\/b>/i)[1];

  return {
    name: name.split(', ' + isin)[0].trim(),
    date,
    start,
    finish
  };
}

console.log(await parse_spbex_halt('US0400476075'));
